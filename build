#!/bin/bash
set -e

PLATFORM="linux/amd64"
EXTRA_ARGUMENTS=""
while true; do
  case "$1" in
    ### Push requires authentication to minimalcompact docker hub
    -p | --push)
        EXTRA_ARGUMENTS="${EXTRA_ARGUMENTS} --push"
        shift
        ;;
    -b | --branch)
        BRANCH="$2";
        shift 2
        ;;
    ### Images have issues building multi arch, so hold behind a feature flag
    -m | --multiarch)
        PLATFORM="${PLATFORM},linux/arm64"
        shift
        ;;
    ## Create should be run once, or in ci, if docker buildx ls doesnt contain supported platforms
    -c | --create)
         docker buildx create --use
         shift
         ;;
    -e | --extra )
        EXTRA_ARGUMENTS="${EXTRA_ARGUMENTS} $2"
        shift 2
        ;;
     * ) break ;;
  esac
done

EXTRA_ARGUMENTS="${EXTRA_ARGUMENTS} --platform $PLATFORM"
THUMBOR_VERSION=$(cat thumbor/requirements.txt| grep thumbor== | cut -d= -f 3)

echo "Branch: ${BRANCH} | Thumbor version: ${THUMBOR_VERSION}"
echo "*******************************************************"

echo "--> BUILDING minimalcompact/thumbor"
[ "$BRANCH" == "master" ] && EXTRA_TAG="--tag ghcr.io/minimalcompact/thumbor:latest"
docker buildx build $EXTRA_ARGUMENTS --pull -f thumbor/Dockerfile \
 --tag minimalcompact/thumbor \
 --tag ghcr.io/minimalcompact/thumbor:$THUMBOR_VERSION \
  $EXTRA_TAG \
 thumbor/

echo "--> BUILDING minimalcompact/thumbor:simd-sse4"
[ "$BRANCH" == "master" ] && EXTRA_TAG="--tag ghcr.io/minimalcompact/thumbor:latest-simd-sse4t"
docker buildx build $EXTRA_ARGUMENTS --build-arg SIMD_LEVEL=sse4 -f thumbor/Dockerfile \
 --tag minimalcompact/thumbor-simd-sse4 \
 --tag ghcr.io/minimalcompact/thumbor:$THUMBOR_VERSION-simd-sse4 \
 $EXTRA_TAG \
 thumbor/


echo "--> BUILDING minimalcompact/thumbor:simd-avx2"
[ "$BRANCH" == "master" ] && EXTRA_TAG="--tag ghcr.io/minimalcompact/thumbor:latest-simd-avx2"
docker buildx build $EXTRA_ARGUMENTS --build-arg SIMD_LEVEL=avx2  -f thumbor/Dockerfile \
 --tag minimalcompact/thumbor-simd-avx2 \
 --tag ghcr.io/minimalcompact/thumbor:$THUMBOR_VERSION-simd-avx2 \
 $EXTRA_TAG \
 thumbor/

echo "--> BUILDING minimalcompact/thumbor-nginx-proxy-cache"
[ "$BRANCH" == "master" ] && EXTRA_TAG="--tag ghcr.io/minimalcompact/thumbor-nginx-proxy-cache:latest"
docker buildx build $EXTRA_ARGUMENTS --pull -f nginx-proxy-cache/Dockerfile \
 --tag minimalcompact/thumbor-nginx-proxy-cache \
 --tag ghcr.io/minimalcompact/thumbor-nginx-proxy-cache:$THUMBOR_VERSION \
 $EXTRA_TAG \
 nginx-proxy-cache/


echo "--> BUILDING minimalcompact/remotecv"
[ "$BRANCH" == "master" ] && EXTRA_TAG="--tag ghcr.io/minimalcompact/remotecv:latest"
docker buildx build --platform=linux/amd64,linux/arm64 --build-arg THUMBOR_TAG=latest -f remotecv/Dockerfile \
 --tag minimalcompact/remotecv \
 --tag ghcr.io/minimalcompact/remotecv:$THUMBOR_VERSION \
 $EXTRA_TAG \
 remotecv/
