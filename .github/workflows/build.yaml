name: Build and test

on:
  push:
    branches:
      - main
      - thumbor-7

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build and test Docker images

    runs-on: ubuntu-latest

    env:
      #PLATFORM=linux/amd64,linux/arm64
      PLATFORM: linux/amd64

    steps:
      - uses: docker/setup-qemu-action@v2

      # This enables native caching from Docker into the GHA cache system:
      - uses: crazy-max/ghaction-github-runtime@v2

      - uses: actions/checkout@v3

      - name: Find version of Thumbor used
        id: thumbor
        run: |
          VERSION=$(cat thumbor/thumbor/requirements.txt| grep thumbor== | cut -d= -f 3)
          if [[ -z "$VERSION" ]]; then
            echo "Failed to find version of Thumbor used"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - run: docker buildx create --use --driver=docker-container

      - name: Build Thumbor base image
        run: |
          docker buildx build \
            --progress plain \
            --platform=$PLATFORM \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-thumbor \
            --cache-to type=gha,scope=$GITHUB_REF_NAME-thumbor,mode=max,push=true \
            --pull \
            --target thumbor \
            -f thumbor/Dockerfile \
            thumbor/

      - name: Build Thumbor w/ Pillow-SIMD images
        run: |
          for SIMD_LEVEL in sse4 avx2; do
            docker buildx build \
              --progress plain \
              --platform=$PLATFORM \
              --cache-from type=gha,scope=$GITHUB_REF_NAME-thumbor-$SIMD_LEVEL \
              --cache-to type=gha,scope=$GITHUB_REF_NAME-thumbor-$SIMD_LEVEL,mode=max,push=true \
              --pull \
              --build-arg SIMD_LEVEL=$SIMD_LEVEL \
              --target pillow_simd \
              -f thumbor/Dockerfile \
              thumbor/
          done

      - name: Build Thumbor RemoteCV image
        run: |
          docker buildx build \
            --progress plain \
            --platform=$PLATFORM \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-remotecv \
            --cache-to type=gha,scope=$GITHUB_REF_NAME-remotecv,mode=max,push=true \
            --pull \
            --target remotecv \
            -f thumbor/Dockerfile \
            thumbor/

      - name: Build Nginx proxy cache image
        run: |
          docker buildx build \
            --progress plain \
            --platform=$PLATFORM \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-nginx-proxy \
            --cache-to type=gha,scope=$GITHUB_REF_NAME-nginx-proxy,mode=max,push=true \
            --pull \
            -f nginx-proxy-cache/Dockerfile \
            nginx-proxy-cache/

      - name: Load Thumbor and Nginx proxy cache images into local Docker
        run: |
          
          # Load image for current platform into local Docker (see https://github.com/docker/buildx/issues/59)
          # To make --load work we have to omit the --platform argument
          
          docker buildx build \
            --progress plain \
            --target thumbor \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-thumbor \
            --load \
            --tag minimalcompact/thumbor \
            -f thumbor/Dockerfile \
            thumbor/

          docker buildx build \
            --progress plain \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-nginx-proxy \
            --load \
            --tag minimalcompact/thumbor-nginx-proxy-cache \
            -f nginx-proxy-cache/Dockerfile \
            nginx-proxy-cache/

      - name: Install Bats
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core
          sudo ./install.sh /usr/local

      - name: Run tests with Bats
        run: |
          for filename in tests/*.bats; do sudo bats --tap "$filename" || exit 1; done

      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push images to ghcr.io registry
        run: |

          docker buildx build \
            --progress plain \
            --platform=$PLATFORM \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-thumbor \
            --tag ghcr.io/MinimalCompact/thumbor:${{ steps.thumbor.outputs.VERSION }} \
            --push \
            --target thumbor \
            -f thumbor/Dockerfile \
            thumbor/

          for SIMD_LEVEL in sse4 avx2; do
            docker buildx build \
              --progress plain \
              --platform=$PLATFORM \
              --cache-from type=gha,scope=$GITHUB_REF_NAME-thumbor-$SIMD_LEVEL \
              --tag ghcr.io/MinimalCompact/thumbor:${{ steps.thumbor.outputs.VERSION }}-simd-$SIMD_LEVEL \
              --push \
              --build-arg SIMD_LEVEL=$SIMD_LEVEL \
              --target pillow_simd \
              -f thumbor/Dockerfile \
              thumbor/
          done

          docker buildx build \
            --progress plain \
            --platform=$PLATFORM \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-remotecv \
            --tag ghcr.io/MinimalCompact/thumbor:${{ steps.thumbor.outputs.VERSION }}-remotecv \
            --push \
            --target remotecv \
            -f thumbor/Dockerfile \
            thumbor/

          docker buildx build \
            --progress plain \
            --platform=$PLATFORM \
            --cache-from type=gha,scope=$GITHUB_REF_NAME-nginx-proxy \
            --tag ghcr.io/MinimalCompact/thumbor:${{ steps.thumbor.outputs.VERSION }}-nginx-proxy-cache \
            --push \
            -f nginx-proxy-cache/Dockerfile \
            nginx-proxy-cache/
