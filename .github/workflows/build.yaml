name: Build and test
on:
  pull_request:
  workflow_dispatch:
  push:
permissions:
  contents: read
jobs:
  build-test-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: get thumbor version
        id: thumbor
        run: |
          echo "VERSION=$(cat thumbor/requirements.txt| grep thumbor== | cut -d= -f 3)" >> $GITHUB_OUTPUT
      - name: build images and load them for testing
        run: |
          ./build --extra "--load" --branch "${GITHUB_REF_NAME}"
      - name: install bats
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core
          sudo ./install.sh /usr/local
      - name: run bats tests
        run: |
          for filename in tests/*.bats; do sudo bats --tap "$filename" || exit 1; done
      - name: push
        # TODO: temporarily pushing thumbor-7
        if: {{ github.ref == 'refs/heads/thumbor-7' || (github.event.pull_request.merged == true && github.ref == 'refs/heads/master') }}
        # TODO: add registry credentials
        run: |
          ./build --multiarch --push --branch "${GITHUB_REF_NAME}"
